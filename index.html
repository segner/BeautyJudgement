<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ã„sthetik Analyse â€” GemÃ¤ldebewertung</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Cinzel:wght@400;600&family=Raleway:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0a08;
    --surface: #141210;
    --card: #1a1714;
    --border: #2e2820;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --gold-dim: #6b5a2e;
    --cream: #f0e8d8;
    --cream-dim: #a09080;
    --text: #e8ddd0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Raleway', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
    opacity: 0.5;
  }

  /* NAV */
  nav {
    display: flex;
    justify-content: center;
    gap: 0;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: rgba(12,10,8,0.95);
    backdrop-filter: blur(8px);
    z-index: 100;
  }
  .nav-btn {
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--cream-dim);
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 4px;
    text-transform: uppercase;
    padding: 18px 32px;
    cursor: pointer;
    transition: color 0.3s, border-color 0.3s;
  }
  .nav-btn:hover { color: var(--cream); }
  .nav-btn.active { color: var(--gold-light); border-bottom-color: var(--gold); }

  header {
    text-align: center;
    padding: 60px 20px 40px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
  }
  .title-ornament {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 6px;
    color: var(--gold-dim);
    text-transform: uppercase;
    margin-bottom: 16px;
  }
  h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(38px, 6vw, 72px);
    font-weight: 300;
    letter-spacing: 2px;
    color: var(--cream);
    line-height: 1.1;
  }
  h1 em { font-style: italic; color: var(--gold-light); }
  .subtitle {
    margin-top: 12px;
    font-size: 12px;
    letter-spacing: 4px;
    color: var(--cream-dim);
    text-transform: uppercase;
  }

  main { max-width: 1400px; margin: 0 auto; padding: 50px 30px; }

  /* PAGES */
  .page { display: none; }
  .page.active { display: block; animation: fadeIn 0.4s ease; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* SECTION LABEL */
  .section-label {
    font-family: 'Cinzel', serif;
    font-size: 11px;
    letter-spacing: 5px;
    color: var(--gold-dim);
    text-transform: uppercase;
    margin-bottom: 24px;
  }

  /* UPLOAD */
  .upload-section { margin-bottom: 60px; }
  .upload-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .upload-slot {
    aspect-ratio: 3/4;
    border: 1px solid var(--border);
    background: var(--card);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s, transform 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .upload-slot:hover { border-color: var(--gold-dim); transform: translateY(-2px); }
  .upload-slot.filled { cursor: default; }
  .upload-slot.filled:hover { transform: none; border-color: var(--gold); }
  .slot-icon { font-size: 28px; opacity: 0.3; margin-bottom: 10px; }
  .slot-label { font-size: 10px; letter-spacing: 3px; color: var(--cream-dim); text-transform: uppercase; }
  .slot-img { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
  .slot-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to top, rgba(12,10,8,0.85) 0%, transparent 50%);
    display: flex; align-items: flex-end; padding: 12px;
    opacity: 0; transition: opacity 0.3s;
  }
  .upload-slot.filled:hover .slot-overlay { opacity: 1; }
  .slot-name { font-size: 11px; color: var(--cream); letter-spacing: 1px; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .remove-btn {
    position: absolute; top: 8px; right: 8px;
    background: rgba(139,32,32,0.8); border: none; color: white;
    width: 22px; height: 22px; cursor: pointer; font-size: 14px;
    line-height: 22px; text-align: center; opacity: 0; transition: opacity 0.3s;
  }
  .upload-slot.filled:hover .remove-btn { opacity: 1; }
  .add-slot { border-style: dashed; }
  input[type=file] { display: none; }

  /* BUTTONS */
  .actions { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
  .btn-primary {
    background: transparent; border: 1px solid var(--gold);
    color: var(--gold-light); font-family: 'Cinzel', serif;
    font-size: 11px; letter-spacing: 4px; text-transform: uppercase;
    padding: 14px 36px; cursor: pointer; position: relative; overflow: hidden; transition: color 0.3s;
  }
  .btn-primary::before {
    content: ''; position: absolute; inset: 0; background: var(--gold);
    transform: translateX(-100%); transition: transform 0.3s; z-index: -1;
  }
  .btn-primary:hover { color: var(--bg); }
  .btn-primary:hover::before { transform: translateX(0); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary:disabled:hover { color: var(--gold-light); }
  .btn-primary:disabled:hover::before { transform: translateX(-100%); }
  .btn-secondary {
    background: transparent; border: 1px solid var(--border);
    color: var(--cream-dim); font-family: 'Raleway', sans-serif;
    font-size: 11px; letter-spacing: 2px; text-transform: uppercase;
    padding: 14px 24px; cursor: pointer; transition: border-color 0.3s, color 0.3s;
  }
  .btn-secondary:hover { border-color: var(--cream-dim); color: var(--cream); }
  .btn-danger {
    background: transparent; border: 1px solid #4a2020;
    color: #c97070; font-family: 'Raleway', sans-serif;
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    padding: 6px 14px; cursor: pointer; transition: border-color 0.3s, color 0.3s;
  }
  .btn-danger:hover { border-color: #8b2020; color: #e08080; }

  /* LOADING */
  .loading-bar { height: 1px; background: var(--border); margin: 40px 0; position: relative; display: none; }
  .loading-bar.active { display: block; }
  .loading-bar::after {
    content: ''; position: absolute; left: 0; top: 0; height: 100%;
    background: linear-gradient(90deg, var(--gold), var(--gold-light));
    animation: loading 1.8s ease-in-out infinite;
  }
  @keyframes loading {
    0% { width: 0%; left: 0; }
    50% { width: 70%; }
    100% { width: 0%; left: 100%; }
  }
  .loading-text { text-align: center; font-family: 'Cormorant Garamond', serif; font-style: italic; color: var(--gold-dim); font-size: 16px; display: none; }
  .loading-text.active { display: block; }

  /* RESULTS */
  .results-section { display: none; }
  .results-section.visible { display: block; animation: fadeIn 0.6s ease; }
  .results-header { display: flex; align-items: baseline; gap: 20px; margin-bottom: 30px; }
  .results-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 32px; font-weight: 300; color: var(--cream); }
  .divider { flex: 1; height: 1px; background: linear-gradient(90deg, var(--border), transparent); }

  /* TABLE */
  .criteria-table-wrap { overflow-x: auto; margin-bottom: 50px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  thead th {
    background: var(--surface); padding: 16px 20px; text-align: left;
    font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 3px;
    color: var(--gold-dim); text-transform: uppercase; font-weight: 400;
    border-bottom: 1px solid var(--border);
  }
  thead th.painting-col { padding: 12px 16px; text-align: center; }
  .th-painting-inner { display: flex; flex-direction: column; align-items: center; gap: 8px; }
  .th-thumb { width: 70px; height: 90px; object-fit: cover; border: 1px solid var(--border); }
  .th-paintname {
    font-family: 'Cormorant Garamond', serif; font-size: 12px; font-weight: 400;
    color: var(--cream); letter-spacing: 0; text-transform: none;
    max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.2s; }
  tbody tr:hover { background: var(--card); }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 18px 20px; vertical-align: middle; }
  td.criterion-cell { width: 200px; min-width: 180px; }
  .criterion-name { font-family: 'Cormorant Garamond', serif; font-size: 17px; font-style: italic; color: var(--cream); display: block; margin-bottom: 3px; }
  .criterion-desc { font-size: 10px; letter-spacing: 1px; color: var(--cream-dim); text-transform: uppercase; }
  td.score-cell { text-align: center; padding: 18px 16px; }
  .score-wrap { display: flex; flex-direction: column; align-items: center; gap: 8px; }
  .score-number { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; line-height: 1; }
  .score-bar-bg { width: 80px; height: 3px; background: var(--border); position: relative; }
  .score-bar-fill { position: absolute; left: 0; top: 0; height: 100%; }
  .score-note { font-size: 10px; color: var(--cream-dim); max-width: 130px; text-align: center; line-height: 1.5; }
  .best-mark { font-size: 9px; letter-spacing: 2px; color: var(--gold); text-transform: uppercase; }
  tr.overall-row { background: var(--surface); }
  tr.overall-row:hover { background: #1e1b18; }
  .overall-score { font-family: 'Cormorant Garamond', serif; font-size: 40px; font-weight: 300; line-height: 1; }
  .rank-badge { display: inline-block; padding: 3px 10px; font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 2px; margin-top: 6px; }
  .rank-1 { border: 1px solid var(--gold); color: var(--gold); }
  .rank-2 { border: 1px solid #8a8a8a; color: #aaa; }
  .rank-3 { border: 1px solid #8b5e2e; color: #b07a50; }
  .rank-other { border: 1px solid var(--border); color: var(--cream-dim); }

  /* SUMMARY CARDS */
  .summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; margin-top: 40px; }
  .summary-card { border: 1px solid var(--border); background: var(--card); padding: 28px; position: relative; }
  .summary-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--gold), transparent); }
  .card-painting-header { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 20px; }
  .card-thumb { width: 60px; height: 75px; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; }
  .card-painting-name { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 300; color: var(--cream); line-height: 1.2; margin-bottom: 6px; }
  .card-overall { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 2px; color: var(--gold-dim); }
  .card-verdict { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 15px; color: var(--cream-dim); line-height: 1.6; border-top: 1px solid var(--border); padding-top: 16px; }

  /* GALLERY */
  .gallery-controls { display: flex; gap: 12px; align-items: center; margin-bottom: 30px; flex-wrap: wrap; }
  .gallery-sort {
    background: var(--card); border: 1px solid var(--border); color: var(--cream);
    font-family: 'Raleway', sans-serif; font-size: 11px; letter-spacing: 1px;
    padding: 8px 14px; cursor: pointer;
  }
  .gallery-sort option { background: var(--card); }
  .gallery-count { font-size: 11px; color: var(--cream-dim); letter-spacing: 2px; margin-left: auto; }

  .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
  .gallery-item {
    border: 1px solid var(--border); background: var(--card);
    overflow: hidden; position: relative;
    transition: border-color 0.3s, transform 0.2s;
    cursor: pointer;
  }
  .gallery-item:hover { border-color: var(--gold-dim); transform: translateY(-3px); }
  .gallery-img { width: 100%; aspect-ratio: 4/3; object-fit: cover; display: block; }
  .gallery-info { padding: 16px; }
  .gallery-name { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 300; color: var(--cream); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .gallery-date { font-size: 10px; letter-spacing: 2px; color: var(--cream-dim); text-transform: uppercase; margin-bottom: 12px; }
  .gallery-scores { display: flex; gap: 8px; flex-wrap: wrap; }
  .gallery-score-chip {
    font-size: 9px; letter-spacing: 1px; padding: 3px 8px;
    border: 1px solid var(--border); color: var(--cream-dim); text-transform: uppercase;
  }
  .gallery-overall { font-family: 'Cormorant Garamond', serif; font-size: 32px; font-weight: 300; margin-bottom: 8px; }
  .gallery-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }

  .gallery-empty { text-align: center; padding: 80px 20px; }
  .gallery-empty-icon { font-size: 48px; opacity: 0.2; margin-bottom: 20px; }
  .gallery-empty-text { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 22px; color: var(--cream-dim); }
  .gallery-empty-sub { font-size: 11px; letter-spacing: 2px; color: var(--gold-dim); text-transform: uppercase; margin-top: 10px; }

  /* MODAL */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(12,10,8,0.92);
    z-index: 500; display: none; align-items: center; justify-content: center;
    padding: 20px;
  }
  .modal-backdrop.open { display: flex; }
  .modal {
    background: var(--surface); border: 1px solid var(--border);
    max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;
    animation: fadeIn 0.3s ease;
  }
  .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 28px; border-bottom: 1px solid var(--border); }
  .modal-title { font-family: 'Cormorant Garamond', serif; font-size: 26px; font-weight: 300; color: var(--cream); }
  .modal-close { background: none; border: none; color: var(--cream-dim); font-size: 22px; cursor: pointer; line-height: 1; }
  .modal-close:hover { color: var(--cream); }
  .modal-body { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }
  .modal-img-wrap { padding: 28px; border-right: 1px solid var(--border); }
  .modal-img { width: 100%; object-fit: contain; max-height: 400px; border: 1px solid var(--border); }
  .modal-scores { padding: 28px; }
  .modal-score-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
  .modal-score-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .modal-crit-name { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 15px; color: var(--cream); flex: 1; }
  .modal-score-val { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 300; min-width: 32px; text-align: right; }
  .modal-verdict { padding: 20px 28px; border-top: 1px solid var(--border); font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 15px; color: var(--cream-dim); line-height: 1.7; }

  /* TOAST */
  .toast {
    position: fixed; bottom: 30px; right: 30px;
    background: var(--card); border: 1px solid var(--gold-dim);
    color: var(--gold-light); font-size: 12px; letter-spacing: 2px;
    text-transform: uppercase; padding: 14px 24px;
    z-index: 9998; transform: translateY(80px); opacity: 0;
    transition: transform 0.4s ease, opacity 0.4s ease;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* STATUS */
  .db-status { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; padding: 6px 14px; border: 1px solid; }
  .db-status.connected { border-color: #2a6b4a; color: #5a9e7a; }
  .db-status.disconnected { border-color: #4a2020; color: #9e5a5a; }
  .db-status.loading { border-color: var(--gold-dim); color: var(--gold-dim); }

  /* ERROR */
  .error-msg { display: none; color: #c97070; font-size: 13px; padding: 12px 18px; border: 1px solid #4a2020; background: #1a1010; margin-top: 16px; }
  .error-msg.visible { display: block; }

  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--gold-dim); }

  @media (max-width: 700px) {
    .upload-grid { grid-template-columns: repeat(2, 1fr); }
    .actions { flex-direction: column; align-items: stretch; }
    .modal-body { grid-template-columns: 1fr; }
    .modal-img-wrap { border-right: none; border-bottom: 1px solid var(--border); }
  }
</style>
</head>
<body>

<header>
  <div class="title-ornament">Kunstkritik Â· Ã„sthetische Analyse</div>
  <h1>GemÃ¤lde<br><em>Bewertung</em></h1>
  <p class="subtitle">KI-gestÃ¼tzte Ã¤sthetische Analyse & Vergleich</p>
</header>

<nav>
  <button class="nav-btn active" onclick="showPage('analyse')">Analyse</button>
  <button class="nav-btn" onclick="showPage('galerie')">Galerie</button>
</nav>

<main>

  <!-- PAGE: ANALYSE -->
  <div class="page active" id="page-analyse">
    <section class="upload-section">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;">
        <div class="section-label" style="margin-bottom:0">I. GemÃ¤lde hochladen</div>
        <div class="db-status loading" id="dbStatus">Verbindeâ€¦</div>
      </div>
      <div style="margin-bottom:28px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <div style="font-family:'Cinzel',serif;font-size:10px;letter-spacing:3px;color:var(--gold-dim);text-transform:uppercase;white-space:nowrap;">API Key</div>
        <input id="apiKeyInput" type="password" placeholder="sk-ant-..." style="background:var(--card);border:1px solid var(--border);color:var(--cream);font-family:'Raleway',sans-serif;font-size:12px;padding:10px 16px;flex:1;max-width:400px;outline:none;letter-spacing:1px;" />
        <span style="font-size:10px;color:var(--cream-dim);letter-spacing:1px;">Dein Anthropic API Key Â· wird nicht gespeichert</span>
      </div>
      <div class="upload-grid" id="uploadGrid">
        <label class="upload-slot add-slot" id="addSlot" title="GemÃ¤lde hinzufÃ¼gen">
          <div class="slot-icon">âŠ•</div>
          <div class="slot-label">GemÃ¤lde laden</div>
          <input type="file" id="fileInput" accept="image/*" multiple>
        </label>
      </div>
      <div class="actions">
        <button class="btn-primary" id="analyzeBtn" disabled>Analyse starten</button>
        <button class="btn-secondary" id="clearBtn">Alles lÃ¶schen</button>
        <span style="color:var(--cream-dim);font-size:11px;letter-spacing:1px;">Min. 1 Â· Max. 8 GemÃ¤lde</span>
      </div>
      <div class="error-msg" id="errorMsg"></div>
    </section>

    <div class="loading-bar" id="loadingBar"></div>
    <div class="loading-text" id="loadingText">Die GemÃ¤lde werden Ã¤sthetisch bewertet â€¦</div>

    <section class="results-section" id="results"></section>
  </div>

  <!-- PAGE: GALERIE -->
  <div class="page" id="page-galerie">
    <div style="display:flex;align-items:baseline;gap:20px;margin-bottom:30px;">
      <div class="section-label" style="margin-bottom:0">GemÃ¤lde-Archiv</div>
      <div class="divider" style="flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)"></div>
    </div>
    <div class="gallery-controls">
      <select class="gallery-sort" id="gallerySort" onchange="renderGallery()">
        <option value="date-desc">Neueste zuerst</option>
        <option value="date-asc">Ã„lteste zuerst</option>
        <option value="score-desc">HÃ¶chste Wertung</option>
        <option value="score-asc">Niedrigste Wertung</option>
        <option value="name-asc">Name Aâ€“Z</option>
      </select>
      <span class="gallery-count" id="galleryCount"></span>
    </div>
    <div id="galleryGrid"></div>
  </div>

</main>

<!-- MODAL -->
<div class="modal-backdrop" id="modal" onclick="closeModal(event)">
  <div class="modal" id="modalInner">
    <div class="modal-header">
      <span class="modal-title" id="modalTitle"></span>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-img-wrap">
        <img class="modal-img" id="modalImg" src="" alt="">
        <div style="margin-top:14px;text-align:center">
          <span class="modal-crit-name" style="font-size:13px;color:var(--cream-dim);letter-spacing:2px;text-transform:uppercase;">Gesamtwertung</span><br>
          <span class="overall-score" id="modalOverall" style="font-family:'Cormorant Garamond',serif;font-size:52px;font-weight:300;"></span><span style="font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--cream-dim)">/10</span>
        </div>
      </div>
      <div class="modal-scores" id="modalScores"></div>
    </div>
    <div class="modal-verdict" id="modalVerdict"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyCI9IulwNF220qiNupru3M_DuBgpbpTi7I",
  authDomain: "beautyjudgement-f5259.firebaseapp.com",
  projectId: "beautyjudgement-f5259",
  storageBucket: "beautyjudgement-f5259.firebasestorage.app",
  messagingSenderId: "653706129548",
  appId: "1:653706129548:web:d6c1b033fe6c6315410ba9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const CRITERIA = [
  { key: 'komposition', name: 'Komposition', desc: 'Bildaufbau & Balance' },
  { key: 'farbgebung', name: 'Farbgebung', desc: 'Harmonie & Palette' },
  { key: 'technik', name: 'Technik', desc: 'Handwerk & AusfÃ¼hrung' },
  { key: 'originalitaet', name: 'OriginalitÃ¤t', desc: 'KreativitÃ¤t & Eigenwilligkeit' },
  { key: 'emotion', name: 'Emotionale Tiefe', desc: 'Stimmung & Wirkung' },
  { key: 'licht', name: 'Licht & Schatten', desc: 'Helldunkel & Modellierung' },
  { key: 'gesamteindruck', name: 'Gesamteindruck', desc: 'Ã„sthetische Wirkung' },
];

const SCORE_COLOR = s => s >= 8 ? '#c9a84c' : s >= 6 ? '#7a9e7a' : s >= 4 ? '#9e9a7a' : '#9e7a7a';

// State
let paintings = [];
let nextId = 1;
let galleryData = [];

// DOM
const uploadGrid = document.getElementById('uploadGrid');
const addSlot = document.getElementById('addSlot');
const fileInput = document.getElementById('fileInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const loadingBar = document.getElementById('loadingBar');
const loadingText = document.getElementById('loadingText');
const results = document.getElementById('results');
const errorMsg = document.getElementById('errorMsg');
const dbStatus = document.getElementById('dbStatus');

// DB Status
function setDbStatus(state) {
  dbStatus.className = 'db-status ' + state;
  dbStatus.textContent = state === 'connected' ? 'Datenbank verbunden' : state === 'disconnected' ? 'Verbindungsfehler' : 'Verbindeâ€¦';
}

// Init: test connection
(async () => {
  try {
    await getDocs(query(collection(db, 'paintings')));
    setDbStatus('connected');
    await loadGallery();
  } catch(e) {
    setDbStatus('disconnected');
    console.error(e);
  }
})();

// Navigation
window.showPage = function(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelector(`[onclick="showPage('${page}')"]`).classList.add('active');
  if (page === 'galerie') renderGallery();
}

// Upload
fileInput.addEventListener('change', e => {
  Array.from(e.target.files).forEach(f => addPainting(f));
  fileInput.value = '';
});

function addPainting(file) {
  if (paintings.length >= 8) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const dataUrl = ev.target.result;
    paintings.push({
      id: nextId++,
      name: file.name.replace(/\.[^.]+$/, ''),
      dataUrl,
      base64: dataUrl.split(',')[1],
      mimeType: file.type
    });
    renderSlots();
  };
  reader.readAsDataURL(file);
}

function removePainting(id) {
  paintings = paintings.filter(p => p.id !== id);
  renderSlots();
}

function renderSlots() {
  Array.from(uploadGrid.children).forEach(c => { if (c.id !== 'addSlot') c.remove(); });
  paintings.forEach(p => {
    const slot = document.createElement('div');
    slot.className = 'upload-slot filled';
    slot.innerHTML = `
      <img class="slot-img" src="${p.dataUrl}" alt="${p.name}">
      <div class="slot-overlay"><span class="slot-name">${p.name}</span></div>
      <button class="remove-btn" title="Entfernen">âœ•</button>`;
    slot.querySelector('.remove-btn').addEventListener('click', () => removePainting(p.id));
    uploadGrid.insertBefore(slot, addSlot);
  });
  addSlot.style.display = paintings.length >= 8 ? 'none' : '';
  analyzeBtn.disabled = paintings.length < 1;
}

clearBtn.addEventListener('click', () => {
  paintings = [];
  renderSlots();
  results.classList.remove('visible');
  results.innerHTML = '';
  showError('');
});

analyzeBtn.addEventListener('click', runAnalysis);

function showError(msg) {
  errorMsg.textContent = msg;
  errorMsg.classList.toggle('visible', !!msg);
}

// Analysis
async function runAnalysis() {
  showError('');
  if (!paintings.length) return;
  analyzeBtn.disabled = true;
  loadingBar.classList.add('active');
  loadingText.classList.add('active');
  results.classList.remove('visible');
  try {
    const analysisResults = await Promise.all(paintings.map(p => analyzePainting(p)));
    renderResults(analysisResults);
    // Save to Firebase
    await saveToFirebase(analysisResults);
    await loadGallery();
    showToast('In der Galerie gespeichert');
  } catch(err) {
    showError('Fehler bei der Analyse: ' + err.message);
  } finally {
    loadingBar.classList.remove('active');
    loadingText.classList.remove('active');
    analyzeBtn.disabled = false;
  }
}

async function analyzePainting(painting) {
  const prompt = `Du bist ein renommierter Kunstkritiker und Ã„sthetiker. Analysiere dieses GemÃ¤lde nach folgenden Kriterien und antworte NUR mit einem validen JSON-Objekt ohne Markdown-CodeblÃ¶cke:

{
  "komposition": { "score": <1-10>, "note": "<prÃ¤gnante Beurteilung, 1-2 SÃ¤tze>" },
  "farbgebung": { "score": <1-10>, "note": "<prÃ¤gnante Beurteilung, 1-2 SÃ¤tze>" },
  "technik": { "score": <1-10>, "note": "<prÃ¤gnante Beurteilung, 1-2 SÃ¤tze>" },
  "originalitaet": { "score": <1-10>, "note": "<prÃ¤gnante Beurteilung, 1-2 SÃ¤tze>" },
  "emotion": { "score": <1-10>, "note": "<prÃ¤gnante Beurteilung, 1-2 SÃ¤tze>" },
  "licht": { "score": <1-10>, "note": "<prÃ¤gnante Beurteilung, 1-2 SÃ¤tze>" },
  "gesamteindruck": { "score": <1-10>, "note": "<prÃ¤gnante Beurteilung, 1-2 SÃ¤tze>" },
  "gesamturteil": "<Ein abschlieÃŸendes, poetisches Urteil Ã¼ber das Werk in 2-3 SÃ¤tzen>"
}

Sei prÃ¤zise, kenntnisreich und differenziert. Vergib keine inflationÃ¤ren 10er.`;

  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if (!apiKey) throw new Error('Bitte zuerst den Anthropic API Key eingeben.');

  const response = await fetch('https://anthropic-proxy.steffen-egner.workers.dev/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1000,
      messages: [{ role: 'user', content: [
        { type: 'image', source: { type: 'base64', media_type: painting.mimeType, data: painting.base64 } },
        { type: 'text', text: prompt }
      ]}]
    })
  });
  const rawText = await response.text();
  let data;
  try { data = JSON.parse(rawText); } catch(e) {
    throw new Error('UngÃ¼ltige Antwort vom Server: ' + rawText.slice(0, 300));
  }
  if (!response.ok || data.error) {
    throw new Error(data.error?.message || 'HTTP ' + response.status + ': ' + rawText.slice(0,300));
  }
  if (!data.content) {
    throw new Error('Unerwartetes Format: ' + JSON.stringify(data).slice(0, 300));
  }
  const text = data.content.map(c => c.text || '').join('');
  const parsed = JSON.parse(text.replace(/```json\s*/g,'').replace(/```/g,'').trim());
  const scores = CRITERIA.map(c => parsed[c.key]?.score || 0);
  const overall = Math.round(scores.reduce((a,b) => a+b,0) / scores.length * 10) / 10;
  return { painting, criteria: parsed, overall };
}

// Firebase save
async function saveToFirebase(analysisResults) {
  for (const result of analysisResults) {
    await addDoc(collection(db, 'paintings'), {
      name: result.painting.name,
      imageData: result.painting.dataUrl,
      criteria: result.criteria,
      overall: result.overall,
      createdAt: serverTimestamp()
    });
  }
}

// Firebase load
async function loadGallery() {
  try {
    const q = query(collection(db, 'paintings'), orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    galleryData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch(e) {
    console.error('Gallery load error:', e);
  }
}

// Delete from Firebase
async function deleteFromGallery(id) {
  await deleteDoc(doc(db, 'paintings', id));
  await loadGallery();
  renderGallery();
  showToast('GemÃ¤lde gelÃ¶scht');
}

// Render gallery
window.renderGallery = function() {
  const sort = document.getElementById('gallerySort').value;
  let data = [...galleryData];
  if (sort === 'date-desc') data.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
  else if (sort === 'date-asc') data.sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
  else if (sort === 'score-desc') data.sort((a,b) => b.overall - a.overall);
  else if (sort === 'score-asc') data.sort((a,b) => a.overall - b.overall);
  else if (sort === 'name-asc') data.sort((a,b) => a.name.localeCompare(b.name));

  const grid = document.getElementById('galleryGrid');
  const count = document.getElementById('galleryCount');
  count.textContent = `${data.length} Werk${data.length !== 1 ? 'e' : ''} im Archiv`;

  if (!data.length) {
    grid.innerHTML = `<div class="gallery-empty">
      <div class="gallery-empty-icon">ðŸ–¼</div>
      <div class="gallery-empty-text">Das Archiv ist noch leer</div>
      <div class="gallery-empty-sub">Analysiere dein erstes GemÃ¤lde</div>
    </div>`;
    return;
  }

  grid.innerHTML = '';
  grid.className = 'gallery-grid';
  data.forEach(item => {
    const date = item.createdAt?.seconds ? new Date(item.createdAt.seconds * 1000).toLocaleDateString('de-DE', { day:'2-digit', month:'long', year:'numeric' }) : 'â€”';
    const color = SCORE_COLOR(item.overall);
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.innerHTML = `
      <img class="gallery-img" src="${item.imageData}" alt="${esc(item.name)}">
      <div class="gallery-info">
        <div class="gallery-overall" style="color:${color}">${item.overall}<span style="font-size:16px;color:var(--cream-dim)">/10</span></div>
        <div class="gallery-name">${esc(item.name)}</div>
        <div class="gallery-date">${date}</div>
        <div class="gallery-scores">
          ${CRITERIA.slice(0,4).map(c => `<span class="gallery-score-chip" style="border-color:${SCORE_COLOR(item.criteria[c.key]?.score||0)};color:${SCORE_COLOR(item.criteria[c.key]?.score||0)}">${c.name.split(' ')[0]} ${item.criteria[c.key]?.score||'?'}</span>`).join('')}
        </div>
        <div class="gallery-actions">
          <button class="btn-secondary" style="font-size:10px;padding:6px 14px;" onclick="openModal('${item.id}')">Details</button>
          <button class="btn-danger" onclick="confirmDelete('${item.id}')">LÃ¶schen</button>
        </div>
      </div>`;
    grid.appendChild(div);
  });
}

// Modal
window.openModal = function(id) {
  const item = galleryData.find(g => g.id === id);
  if (!item) return;
  document.getElementById('modalTitle').textContent = item.name;
  document.getElementById('modalImg').src = item.imageData;
  document.getElementById('modalOverall').textContent = item.overall;
  document.getElementById('modalOverall').style.color = SCORE_COLOR(item.overall);

  let scoresHtml = '';
  CRITERIA.forEach(c => {
    const s = item.criteria[c.key]?.score || 0;
    scoresHtml += `<div class="modal-score-row">
      <div>
        <div class="modal-crit-name">${c.name}</div>
        <div style="font-size:10px;color:var(--cream-dim);margin-top:2px">${item.criteria[c.key]?.note||''}</div>
      </div>
      <span class="modal-score-val" style="color:${SCORE_COLOR(s)}">${s}</span>
    </div>`;
  });
  document.getElementById('modalScores').innerHTML = scoresHtml;
  document.getElementById('modalVerdict').textContent = item.criteria.gesamturteil || '';
  document.getElementById('modal').classList.add('open');
}

window.closeModal = function(e) {
  if (!e || e.target === document.getElementById('modal')) {
    document.getElementById('modal').classList.remove('open');
  }
}

window.confirmDelete = async function(id) {
  if (confirm('Dieses GemÃ¤lde wirklich aus dem Archiv lÃ¶schen?')) {
    await deleteFromGallery(id);
  }
}

// Results rendering (same as before)
function renderResults(data) {
  const sorted = [...data].sort((a,b) => b.overall - a.overall);
  let html = `<div class="results-header"><h2>Analyse&shy;ergebnis</h2><div class="divider"></div></div>
  <div class="criteria-table-wrap"><table><thead><tr><th>Kriterium</th>
  ${sorted.map(d => `<th class="painting-col"><div class="th-painting-inner">
    <img class="th-thumb" src="${d.painting.dataUrl}" alt="">
    <span class="th-paintname">${esc(d.painting.name)}</span>
  </div></th>`).join('')}</tr></thead><tbody>`;

  CRITERIA.forEach(crit => {
    const scores = sorted.map(d => d.criteria[crit.key]?.score || 0);
    const maxScore = Math.max(...scores);
    html += `<tr><td class="criterion-cell"><span class="criterion-name">${crit.name}</span><span class="criterion-desc">${crit.desc}</span></td>`;
    sorted.forEach(d => {
      const s = d.criteria[crit.key]?.score || 0;
      const isBest = s === maxScore && scores.filter(x => x === maxScore).length === 1;
      const color = SCORE_COLOR(s);
      html += `<td class="score-cell"><div class="score-wrap">
        <span class="score-number" style="color:${color}">${s}</span>
        <div class="score-bar-bg"><div class="score-bar-fill" style="width:${s*10}%;background:${color}"></div></div>
        ${isBest ? '<span class="best-mark">â˜… Bestes</span>' : ''}
        <span class="score-note">${esc(d.criteria[crit.key]?.note||'')}</span>
      </div></td>`;
    });
    html += '</tr>';
  });

  html += `<tr class="overall-row"><td class="criterion-cell"><span class="criterion-name">Gesamtwertung</span><span class="criterion-desc">Gewichteter Durchschnitt</span></td>`;
  sorted.forEach((d,i) => {
    const rank = i+1;
    const label = rank===1?'I. Platz':rank===2?'II. Platz':rank===3?'III. Platz':`${rank}. Platz`;
    const cls = rank<=3?`rank-${rank}`:'rank-other';
    const color = SCORE_COLOR(d.overall);
    html += `<td class="score-cell"><div class="score-wrap">
      <span class="overall-score" style="color:${color}">${d.overall}</span>
      <div class="score-bar-bg"><div class="score-bar-fill" style="width:${d.overall*10}%;background:${color}"></div></div>
      <span class="rank-badge ${cls}">${label}</span>
    </div></td>`;
  });

  html += `</tr></tbody></table></div>
  <div class="section-label" style="margin-top:50px;margin-bottom:24px;">II. Ã„sthetische Urteile</div>
  <div class="summary-grid">`;
  sorted.forEach((d,i) => {
    const rank = i+1;
    const cls = rank<=3?`rank-${rank}`:'rank-other';
    html += `<div class="summary-card">
      <div class="card-painting-header">
        <img class="card-thumb" src="${d.painting.dataUrl}" alt="">
        <div>
          <div class="card-painting-name">${esc(d.painting.name)}</div>
          <div class="card-overall">Gesamtwertung: ${d.overall}/10</div>
          <div style="margin-top:8px"><span class="rank-badge ${cls}" style="display:inline-block">${rank===1?'I.':rank===2?'II.':rank===3?'III.':rank+'.'} Platz</span></div>
        </div>
      </div>
      <p class="card-verdict">${esc(d.criteria.gesamturteil||'')}</p>
    </div>`;
  });
  html += '</div>';

  results.innerHTML = html;
  results.classList.add('visible');
  results.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Toast
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function esc(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
